<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Serviço ST - Cadastro de Empresa</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        .container { background-color: #fff; padding: 20px 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto; }
        h2 { color: #333; border-bottom: 2px solid #0056b3; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input[type="text"], select, input[type="file"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        /* Estilo para o grupo de simulação */
        .radio-group { margin-bottom: 15px; background: #eef; padding: 10px; border-radius: 5px; border: 1px solid #ccd; }
        .radio-group label { display: inline; font-weight: normal; margin-right: 15px; cursor: pointer; }
        
        /* Estilo visual para opção desabilitada */
        input[type="radio"]:disabled + label { color: #999; cursor: not-allowed; text-decoration: line-through; }
        
        .hidden { display: none; }
        button { background-color: #0056b3; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; }
        button:hover { background-color: #004494; }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 300px; border-radius: 8px; text-align: center; }
        .btn-fechar { background-color: #dc3545; margin-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Cadastro de Empresa</h2>

    <div class="radio-group">
        <strong>Simular acesso como:</strong><br>
        <div style="margin-top:5px;">
            <input type="radio" name="tipoUsuario" id="userExterno" value="externo" checked>
            <label for="userExterno">Usuário Externo</label>
            
            <input type="radio" name="tipoUsuario" id="userInterno" value="interno">
            <label for="userInterno" id="labelInterno">Usuário Interno (Admin)</label>
        </div>
        <small id="msgPermissao" style="color:red; display:none; font-size:11px; margin-top:5px;">* Acesso restrito a perfis administrativos.</small>
    </div>

    <form id="formCadastro">
        <div class="form-group">
            <label>Tipo de Pessoa:</label>
            <input type="radio" name="tipoPessoa" id="pj" value="juridica" checked> <label for="pj" style="display:inline; font-weight:normal; margin-right:15px;">Jurídica</label>
            <input type="radio" name="tipoPessoa" id="pf" value="fisica"> <label for="pf" style="display:inline; font-weight:normal; margin-right:15px;">Física</label>
            <input type="radio" name="tipoPessoa" id="pe" value="estrangeira"> <label for="pe" style="display:inline; font-weight:normal;">Estrangeira</label>
        </div>

        <div id="campos_pj">
            <div class="form-group">
                <label for="razaoSocial">Razão Social *</label>
                <input type="text" id="razaoSocial" placeholder="Ex: Empresa LTDA">
            </div>
            <div class="form-group">
                <label for="cnpj">CNPJ * (14 dígitos)</label>
                <input type="text" id="cnpj" maxlength="14" placeholder="Somente números">
            </div>
        </div>

        <div id="campos_pf" class="hidden">
            <div class="form-group">
                <label for="nome">Nome *</label>
                <input type="text" id="nome" placeholder="Nome Completo">
            </div>
            <div class="form-group">
                <label for="cpf">CPF * (11 dígitos)</label>
                <input type="text" id="cpf" maxlength="11" placeholder="Somente números">
            </div>
        </div>

        <div id="campos_pe" class="hidden">
            <div class="form-group">
                <label for="razaoSocialEst">Razão Social *</label>
                <input type="text" id="razaoSocialEst" placeholder="Nome da Empresa Estrangeira">
            </div>
            <div class="form-group">
                <label for="idEstrangeiro">Identificador Estrangeiro *</label>
                <input type="text" id="idEstrangeiro" placeholder="Ex: EIN, VAT number">
            </div>
        </div>

        <div class="form-group">
            <label for="nomeFantasia">Nome Fantasia *</label>
            <input type="text" id="nomeFantasia" required>
        </div>

        <div class="form-group">
            <label for="perfil">Perfil *</label>
            <select id="perfil" required>
                <option value="">Selecione...</option>
                <option value="despachante">Despachante Beneficiário</option>
                <option value="armador">Consignatário Armador</option>
                <option value="agente">Agente de Carga</option>
                <option value="transportadora">Transportadora</option>
            </select>
        </div>

        <div class="form-group" style="display:flex; align-items:center;">
            <input type="checkbox" id="faturamentoDireto" style="width:auto; margin-right:10px;">
            <label for="faturamentoDireto" style="margin:0; font-weight:normal;">Acionar Faturamento Direto</label>
        </div>

        <div class="form-group">
            <label for="documento">Documento Comprobatório * (pdf, png, jpg, jpeg)</label>
            <input type="file" id="documento" accept=".pdf, .png, .jpg, .jpeg" required>
        </div>

        <button type="button" onclick="salvarCadastro()">+ Salvar</button>
    </form>
</div>

<div id="modalSistema" class="modal">
    <div class="modal-content">
        <h3 id="modalTitulo">Aviso</h3>
        <p id="modalMensagem">Mensagem aqui</p>
        <button class="btn-fechar" onclick="fecharModal()">Fechar</button>
    </div>
</div>

<script>
    // --- LÓGICA DE VERIFICAÇÃO DE COOKIES ---
    function getCookie(nome) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${nome}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    function verificarPermissoesInternas() {
        // Lista de cookies que permitem acesso interno
        // Nota: Verifica se o cookie existe (não nulo)
        const temMaster = getCookie("EMPRESA_MASTER") !== null;
        const temLista = getCookie("EMPRESA_LISTA") !== null;
        const temEdicao = getCookie("EMPRESA_EDICAO") !== null;

        const radioInterno = document.getElementById("userInterno");
        const msgPermissao = document.getElementById("msgPermissao");

        // Se NÃO tiver nenhum dos cookies de permissão
        if (!temMaster && !temLista && !temEdicao) {
            radioInterno.disabled = true; // Desabilita o input
            document.getElementById("userExterno").checked = true; // Força seleção externo
            msgPermissao.style.display = "block"; // Mostra msg de erro
            console.log("Acesso Interno Bloqueado: Cookies de permissão não encontrados.");
        } else {
            radioInterno.disabled = false;
            msgPermissao.style.display = "none";
            console.log("Acesso Interno Liberado.");
        }
    }

    // Executa a verificação assim que a página carrega
    window.onload = function() {
        verificarPermissoesInternas();
    };
    // ----------------------------------------

    // Alternância dos campos de acordo com o Tipo de Pessoa
    const radios = document.querySelectorAll('input[name="tipoPessoa"]');
    radios.forEach(radio => {
        radio.addEventListener('change', function() {
            document.getElementById('campos_pj').classList.add('hidden');
            document.getElementById('campos_pf').classList.add('hidden');
            document.getElementById('campos_pe').classList.add('hidden');
            
            if(this.value === 'juridica') {
                document.getElementById('campos_pj').classList.remove('hidden');
            } else if (this.value === 'fisica') {
                document.getElementById('campos_pf').classList.remove('hidden');
            } else if (this.value === 'estrangeira') {
                document.getElementById('campos_pe').classList.remove('hidden');
            }
        });
    });

    function mostrarModal(titulo, mensagem) {
        document.getElementById('modalTitulo').innerText = titulo;
        document.getElementById('modalMensagem').innerText = mensagem;
        document.getElementById('modalSistema').style.display = 'block';
    }

    function fecharModal() {
        document.getElementById('modalSistema').style.display = 'none';
    }

    function salvarCadastro() {
        const tipoUsuario = document.querySelector('input[name="tipoUsuario"]:checked').value;
        const tipoPessoa = document.querySelector('input[name="tipoPessoa"]:checked').value;
        const name = document.querySelector('input[id="razaoSocial"]').value;
        const social_name = document.getElementById('nomeFantasia').value
        const profile = document.getElementById('perfil').value
        const invoicing = document.getElementById('faturamentoDireto').value
        let identity;
        const formData = new FormData()
        

        if(!profile) {
            mostrarModal("Atenção", "Selecione um perfil para a empresa.");
            return;
        }

        if(tipoPessoa === 'juridica') {
            identity = document.getElementById('cnpj').value;
            if(identity.length !== 14) {
                mostrarModal("Atenção", "CNPJ fornecido inválido. Precisa ter 14 caracteres.");
                return;
            }
        } else if (tipoPessoa === 'fisica') {
            identity = document.getElementById('cpf').value;
            if(identity.length !== 11) {
                mostrarModal("Atenção", "CPF inválido. Precisa ter 11 caracteres.");
                return;
            }
        } else {
            identity = document.getElementById('idEstrangeiro').value;
            return;
        }

        const doc = document.getElementById('documento').files[0];
        if(!doc) {
            mostrarModal("Aviso", "É necessário enviar os arquivos obrigatórios para prosseguir.");
            return;
        } else {
            const extensao = doc.name.split('.').pop().toLowerCase();
            const permitidos = ['pdf', 'png', 'jpg', 'jpeg'];
            if(!permitidos.includes(extensao)) {
                mostrarModal("Arquivo inválido", "São válidos somente arquivos do tipo: pdf, png, jpg ou jpeg.");
                return;
            }
        }
        formData.append('file', doc)
        
        if (tipoUsuario === 'interno') {
            formData.append('company_info', JSON.stringify({
                            service_type: tipoPessoa,
                            name: name,
                            identity: identity,
                            social_name: social_name,
                            profile: profile,
                            direct_invoicing: invoicing,
                            status: 'APPROVED'
                        }))
                        fetch('http://127.0.0.1:8000/save-company-info', {
                            method: 'POST',
                            body: formData 
                        })
                        .then(response => {
                            if (response.ok) {
                                alert("Login efetuado com sucesso no servidor local!");
                                window.location.href = "index";
                            } else {
                                throw new Error('Problemas com a conexão do servidor.');
                            }
            })
            .catch(error => {
                console.error('Erro de requisição:', error);
                alert("Erro ao tentar fazer login: " + error.message + " (Verifique se o backend no localhost está rodando).");
            });
            mostrarModal("Sucesso", "Empresa cadastrada com sucesso! APROVADO AUTOMATICAMENTE (Usuário Interno).");
        } else {
            formData.append('company_info', JSON.stringify({
                            service_type: tipoPessoa,
                            name: name,
                            identity: identity,
                            social_name: social_name,
                            profile: profile,
                            direct_invoicing: invoicing,
                            status: 'PENDING'
                        }))
            fetch('http://127.0.0.1:8000/save-company-info', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    alert("Empresa cadastrada com sucesso! ESPERANDO APROVAÇÃO");
                    window.location.href = "index";
                } else {
                    throw new Error('Problemas com a conexão do servidor.');
                }
            })
            .catch(error => {
                console.error('Erro de requisição:', error);
                alert("Erro ao tentar fazer login: " + error.message + " (Verifique se o backend no localhost está rodando).");
            });
            mostrarModal("Sucesso", "Empresa cadastrada com sucesso! AGUARDANDO APROVAÇÃO (Usuário Externo).");
        }
    }
</script>

</body>
</html>